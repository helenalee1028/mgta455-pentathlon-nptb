---
title: "R Notebook"
output: html_notebook
---

```{r}
## Loading the data from Dropbox/MGTA455-2019/data/
pentathlon_nptb <- readr::read_rds(file.path(radiant.data::find_dropbox(), "MGTA455-2019/data/pentathlon_nptb.rds"))
```


```{r}
## filter and sort the dataset
pentathlon_nptb_train <- pentathlon_nptb %>%
  filter(training == 1) %>%
  select(custid:representative)
register("pentathlon_nptb_train", "pentathlon_nptb")
# dtab(pentathlon_nptb_train, dec = 2, nr = 100) %>% render()
pentathlon_nptb_test <- pentathlon_nptb %>%
  filter(training == 0) %>%
  select(custid:representative)
register("pentathlon_nptb_test", "pentathlon_nptb")
```

Logistic regression with interactionï¼š
with all best 19 interactions

```{r}
result <- logistic(
  pentathlon_nptb_train, 
  rvar = "buyer", 
  evar = c(
    "message", "age", "gender", "income", "education", "children", 
    "freq_endurance", "freq_strength", "freq_water", "freq_team", 
    "freq_backcountry", "freq_winter", "freq_racquet"
  ), 
  lev = "yes", 
  int = c(
    "message:age", "message:gender", 
    "age:gender", "age:income", 
    "age:education", "age:children", 
    "age:freq_endurance", 
    "age:freq_strength", 
    "age:freq_water", "age:freq_team", 
    "gender:income", "income:education", 
    "income:children", "income:freq_endurance", 
    "income:freq_strength", 
    "income:freq_water", 
    "income:freq_backcountry", 
    "education:freq_winter", 
    "education:freq_racquet"
  )
)
summary(result)

pred <- predict(result, pred_data = pentathlon_nptb_test)
pentathlon_nptb_test <- store(pentathlon_nptb_test, pred, name = "pred_logit")
```

Calculate accuracy.
```{r}
cm <- function(dat, vars){
  
  cm_df <- as.data.frame(matrix(NA, ncol = 3, nrow = length(vars)))
  colnames(cm_df) <- c("var", "auc", "accuracy")
  
  for (i in 1:length(vars)){
    
    var <- vars[i]
    probs <- pull(dat, !!var)
    resp <- pull(dat, "buyer")
    
    predict <- ifelse(pull(dat, !!var) > 0.5, "TRUE", "FALSE") # predict whether a customer will buy 
    
    accuracy <- (sum(resp == "yes" & predict == "TRUE") + sum(resp == "no" & predict == "FALSE"))/nrow(dat)
    
    auc <- ModelMetrics::auc(ifelse(resp=="yes",1,0), probs)
    
    cm_vec <- c(var, auc, accuracy)
    cm_df[i,] <- cm_vec
  }
  return(cm_df)
}
```


```{r}
cm(pentathlon_nptb_test,'pred_logit')
```
